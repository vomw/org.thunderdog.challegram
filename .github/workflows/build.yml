name: Build Telegram X

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          repository: TGX-Android/Telegram-X
          submodules: recursive
          lfs: true
          # fetch-depth: 0

      # - name: Initialize Submodules (Manual Restore)
      #   run: |
      #     chmod +x scripts/restore_submodules.sh
      #     bash scripts/restore_submodules.sh
          
      #     echo "=== Verification ==="
      #     ls -R vkryl | head -n 5 || echo "vkryl missing"
      #     ls -A app/jni/third_party/opus || echo "opus missing"

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y $(sed 's/=.*//' reproducible-builds/dependencies.txt)

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Decode Keystore
        if: env.KEYSTORE_BASE64 != ''
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 --decode > release.keystore

      - name: Create keystore.properties
        if: env.KEYSTORE_PASSWORD != ''
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          cat <<EOF > keystore.properties
          keystore.file=$(pwd)/release.keystore
          keystore.password=$KEYSTORE_PASSWORD
          key.alias=$KEY_ALIAS
          key.password=$KEY_PASSWORD
          EOF

      - name: Create local.properties
        env:
          TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
          TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
        run: |
          echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV
          
          cat <<EOF > local.properties
          sdk.dir=$ANDROID_HOME
          keystore.file=$(pwd)/keystore.properties
          telegram.api_id=${TELEGRAM_API_ID:-12345}
          telegram.api_hash=${TELEGRAM_API_HASH:-0123456789abcdef0123456789abcdef}
          app.id=org.thunderdog.challegram
          app.name=Telegram X
          app.download_url=https://t.me/tgx_log
          app.sources_url=https://github.com/TGX-Android/Telegram-X
          EOF

      - name: Run Setup Script
        env:
          TERM: dumb
        run: |
          chmod +x scripts/*.sh
          chmod -R +x scripts/
          chmod +x gradlew
          
          # Remove tput calls in set-env.sh to avoid terminal errors
          sed -i 's/\$(tput [^)]*)//g' scripts/set-env.sh
          
          export ANDROID_SDK_ROOT=$ANDROID_HOME
          bash scripts/setup.sh

      - name: Build with Gradle
        run: ./gradlew --debug assembleLatestUniversalRelease

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: telegram-x-universal-release
          path: app/build/outputs/apk/latest/universal/release/*.apk
